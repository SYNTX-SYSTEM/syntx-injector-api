"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¯ SYNTX SCORING ROUTER v2.0 - FIELDBRAIN EDITION                           â•‘
â•‘  Field-based Response Scoring mit Dynamic Profiles                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import Dict, List, Any, Optional

# Import scoring engine
import sys
from pathlib import Path
sys.path.append(str(Path(__file__).parent.parent))
from scoring.router import score_response, get_available_scorers

router = APIRouter(prefix="/resonanz", tags=["scoring"])


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ğŸ“¦ MODELS - UPDATED FOR FIELDBRAIN v0.1
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class FieldDefinition(BaseModel):
    name: str
    weight: float = 1.0

class FormatDefinition(BaseModel):
    name: str
    fields: List[FieldDefinition]

class ScoreRequest(BaseModel):
    text: str = Field(..., description="Response text to score")
    format: FormatDefinition = Field(..., description="Format with fields to score against")

class ScoredField(BaseModel):
    """FIELDBRAIN v0.1 - Profile-based scoring"""
    name: str
    score: float
    weight: float
    weighted_score: float
    profile_used: str  # NEW: Which profile was used
    profile_name: Optional[str] = None  # NEW: Human-readable name
    strategy: Optional[str] = None  # NEW: Strategy used
    components: Optional[Dict] = None  # NEW: Component breakdown
    auto_registered: Optional[bool] = False  # NEW: Was field auto-registered?

class ScoreResponse(BaseModel):
    scored_fields: List[ScoredField]
    total_score: float
    format_name: str
    field_count: int
    total_weight: float
    fieldbrain_version: Optional[str] = "0.1.0"  # NEW


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ğŸ¯ ENDPOINTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.post("/chat/score", response_model=ScoreResponse)
async def score_chat_response(request: ScoreRequest):
    """
    ğŸ¯ Score Response gegen Format-Felder
    
    **FIELDBRAIN v0.1 - Profile-Based Scoring**
    
    Nimmt:
    - `text`: Der LLM Response Text
    - `format`: Format Definition mit Feldern + Gewichten
    
    Gibt zurÃ¼ck:
    - Scores fÃ¼r jedes Feld (0.0-1.0)
    - Profile verwendet
    - Component breakdown
    - Gesamt-Score (normalisiert)
    
    **Beispiel:**
```json
    {
      "text": "Das System driftet stark...",
      "format": {
        "name": "syntx_test",
        "fields": [
          {"name": "driftkorper", "weight": 1.0}
        ]
      }
    }
```
    """
    try:
        # Convert Pydantic models to dicts
        format_dict = {
            "name": request.format.name,
            "fields": [
                {"name": f.name, "weight": f.weight}
                for f in request.format.fields
            ]
        }
        
        # Score the response
        result = score_response(format_dict, request.text)
        
        # Check for errors
        if "error" in result:
            raise HTTPException(status_code=400, detail=result["error"])
        
        return result
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Scoring failed: {str(e)}")


@router.get("/scoring/available")
async def get_available_scoring_methods():
    """
    ğŸ” Liste verfÃ¼gbare Scorer
    
    **FIELDBRAIN v0.1 - Returns Profiles, not functions**
    
    Zeigt:
    - Alle verfÃ¼gbaren Scoring Profiles
    - Total count
    
    **Beispiel Response:**
```json
    {
      "profiles": {
        "default_fallback": {...},
        "flow_bidir_v1": {...}
      },
      "total_profiles": 4
    }
```
    """
    return get_available_scorers()


@router.get("/scoring/health")
async def scoring_health():
    """
    ğŸ¥ Scoring System Health Check
    
    PrÃ¼ft:
    - Scoring Module verfÃ¼gbar
    - Profiles geladen
    - Registry funktioniert
    """
    try:
        scorers = get_available_scorers()
        
        return {
            "status": "ğŸŸ¢ FIELDBRAIN AKTIV",
            "version": "0.1.0",
            "profiles_loaded": scorers.get("total_profiles", 0),
            "note": "Profile-based scoring operational"
        }
    except Exception as e:
        return {
            "status": "ğŸ”´ SCORING ERROR",
            "error": str(e)
        }
